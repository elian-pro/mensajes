<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Zebra</title>
    <link href="https://cdn.jsdelivr.net/npm/@n8n/chat/dist/style.css" rel="stylesheet" />
    <style>
           * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; font-family: Arial, sans-serif; overflow: hidden; background: #ffffff; }
    
    /* 🎨 PERSONALIZACIÓN DEL CHAT N8N - COLOR NEGRO EN HEADER */
    :root {
        --chat--color-dark: #000000 !important;
        --chat--color-white: #ffffff !important;
    }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; font-family: Arial, sans-serif; overflow: hidden; background: #ffffff; }
        .main-container { display: flex; flex-direction: column; width: 100%; height: 100vh; }
        .top-section { width: 100%; background: #000000; color: white; padding: 20px 40px; border-bottom: 3px solid #000000; position: relative; }
        .logo-container { text-align: center; margin-bottom: 15px; }
        .logo-container img { height: 50px; margin-bottom: 8px; }
        .logo-container h1 { font-size: 22px; font-weight: 600; color: #ffffff; }
        .user-info { position: absolute; top: 20px; right: 40px; display: flex; align-items: center; gap: 15px; color: white; font-size: 14px; }
        .btn-logout { padding: 8px 16px; background: #ffffff20; color: white; border: 1px solid white; border-radius: 4px; cursor: pointer; font-size: 12px; transition: all 0.3s; }
        .btn-logout:hover { background: #ffffff40; }
        .instructions-full { background: #1a1a1a; border: 2px solid #333333; padding: 12px 20px; border-radius: 8px; max-width: 1200px; margin: 0 auto; }
        .instructions-full h3 { color: #ffffff; margin-bottom: 8px; font-size: 14px; }
        .instructions-full ul { margin-left: 20px; color: #e0e0e0; font-size: 12px; line-height: 1.4; }
        .instructions-full li { margin-bottom: 4px; }
        .split-section { display: flex; flex: 1; width: 100%; overflow: hidden; }
        .left-panel { width: 50%; height: 100%; background: #ffffff; display: flex; flex-direction: column; border-right: 3px solid #000000; padding: 30px; overflow-y: auto; }
        .section { margin-bottom: 25px; }
        .section h2 { color: #000000; margin-bottom: 15px; font-size: 20px; font-weight: 600; }
        textarea { width: 100%; min-height: 200px; padding: 15px; border: 3px solid #000000; border-radius: 8px; font-family: Arial, sans-serif; font-size: 14px; resize: vertical; outline: none; transition: all 0.3s; background: white; }
        textarea:focus { border-color: #333333; box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1); }
        .btn-ajustar { width: 100%; padding: 18px; background: #000000; color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-ajustar:hover { background: #333333; transform: translateY(-2px); }
        .btn-ajustar:active { transform: translateY(0); }
        .btn-ajustar:disabled { background: #666666; cursor: wait; transform: none; }
        .spinner { width: 20px; height: 20px; border: 3px solid #ffffff40; border-top-color: #ffffff; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .status-message { margin-top: 15px; padding: 12px; border-radius: 6px; text-align: center; display: none; font-weight: 500; transition: all 0.3s; }
        .status-message.success { background: #d4edda; color: #155724; border: 3px solid #000000; }
        .status-message.error { background: #f8d7da; color: #721c24; border: 3px solid #000000; }
        .status-message.processing { background: #fff3cd; color: #856404; border: 3px solid #000000; }
        .right-panel { width: 50%; height: 100%; background: #f8f9fa; position: relative; }
        #n8n-chat { width: 100%; height: 100%; position: absolute; top: 0; left: 0; }
        .session-controls { margin-top: 15px; padding: 10px; background: #f0f0f0; border-radius: 6px; text-align: center; }
        .session-id-display { font-size: 11px; color: #666; margin-bottom: 8px; word-break: break-all; }
        .btn-reset { padding: 8px 16px; background: #666; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; }
        .btn-reset:hover { background: #444; }
        
        /* 🆕 ESTILOS PARA NUEVO PROMPT */
        .btn-nuevo-prompt { width: 100%; padding: 15px; background: #4a4a4a; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-nuevo-prompt:hover { background: #333333; transform: translateY(-1px); }
        .nuevo-prompt-section { display: none; margin-bottom: 25px; padding: 20px; background: #f9f9f9; border: 3px solid #000000; border-radius: 8px; }
        .nuevo-prompt-section.active { display: block; animation: slideDown 0.3s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .nuevo-prompt-section h2 { color: #000000; margin-bottom: 15px; font-size: 18px; font-weight: 600; }
        .nuevo-prompt-section textarea { min-height: 250px; background: white; }
        .btn-enviar-prompt { width: 100%; padding: 15px; background: #000000; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 10px; }
        .btn-enviar-prompt:hover { background: #333333; transform: translateY(-2px); }
        .btn-enviar-prompt:disabled { background: #666666; cursor: wait; transform: none; }
        .btn-cancelar-prompt { width: 100%; padding: 12px; background: transparent; color: #666; border: 2px solid #666; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; margin-top: 8px; }
        .btn-cancelar-prompt:hover { background: #f0f0f0; border-color: #333; color: #333; }
        
        @media (max-width: 768px) {
            .split-section { flex-direction: column; }
            .left-panel, .right-panel { width: 100%; height: 50%; }
            .user-info { position: relative; top: 0; right: 0; justify-content: center; margin-top: 10px; }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="top-section">
            <div class="user-info">
                <span id="userNameDisplay">👤 Usuario</span>
                <button id="btnLogout" class="btn-logout">Cerrar Sesión</button>
            </div>
            <div class="logo-container">
                <img src="Logo_Zebra_Blanco.png" alt="Zebra">
                <h1>Panel de Ajustes de IA</h1>
            </div>
            <div class="instructions-full">
                <h3>¿Cómo funciona?</h3>
                <ul>
                    <li><strong>Paso 1:</strong> Prueba el chat en el panel derecho</li>
                    <li><strong>Paso 2:</strong> Escribe las correcciones en el panel izquierdo</li>
                    <li><strong>Paso 3:</strong> Haz clic en "Ajustar Prompt" y espera la confirmación</li>
                    <li><strong>Nuevo Prompt:</strong> Usa el botón "Nuevo Prompt" para reescribir completamente el prompt base</li>
                    <li><strong>Sesión Persistente:</strong> Tu conversación se mantiene aunque refresques la página</li>
                </ul>
            </div>
        </div>
        <div class="split-section">
            <div class="left-panel">
                <!-- 🆕 BOTÓN Y SECCIÓN PARA NUEVO PROMPT -->
                <button id="btnNuevoPrompt" class="btn-nuevo-prompt">
                    📝 Nuevo Prompt
                </button>
                
                <div id="nuevoPromptSection" class="nuevo-prompt-section">
                    <h2>Escribe el nuevo prompt completo</h2>
                    <textarea id="nuevoPromptInput" placeholder="Escribe aquí el prompt completo que quieres usar como base para la IA...&#10;&#10;Ejemplo:&#10;&#10;Eres un asistente virtual experto en atención al cliente. Tu objetivo es ayudar a los usuarios de manera amable, profesional y eficiente. Siempre debes:&#10;- Mantener un tono cordial y profesional&#10;- Responder de manera clara y concisa&#10;- Ofrecer soluciones prácticas&#10;- Pedir aclaraciones cuando sea necesario"></textarea>
                    <button id="btnEnviarPrompt" class="btn-enviar-prompt">Enviar Prompt</button>
                    <button id="btnCancelarPrompt" class="btn-cancelar-prompt">Cancelar</button>
                    <div id="statusMessagePrompt" class="status-message"></div>
                </div>
                
                <div class="section">
                    <h2>Escribe tus correcciones</h2>
                    <textarea id="notasInput" placeholder="Ejemplo:&#10;&#10;- Usa un tono más formal en las respuestas&#10;- No uses emojis&#10;- Explica conceptos técnicos de manera sencilla&#10;- Responde siempre en español"></textarea>
                </div>
                <button id="btnAjustar" class="btn-ajustar">Ajustar Prompt</button>
                <div id="statusMessage" class="status-message"></div>
                <div class="session-controls">
                    <div class="session-id-display">Session ID: <strong id="sessionIdDisplay">Cargando...</strong></div>
                    <button id="btnResetSession" class="btn-reset">🔄 Nueva Sesión (Borrar Memoria)</button>
                </div>
            </div>
            <div class="right-panel">
                <div id="n8n-chat"></div>
            </div>
        </div>
    </div>
    <script type="module">
        // 🔐 PROTECCIÓN: Verificar autenticación
        if (sessionStorage.getItem('zebra_auth') !== 'true') {
            window.location.href = 'login.html';
        }

        // Mostrar nombre de usuario
        const userName = sessionStorage.getItem('zebra_name') || 'Usuario';
        document.getElementById('userNameDisplay').textContent = '👤 ' + userName;

        // Botón de logout
        document.getElementById('btnLogout').addEventListener('click', () => {
            if (confirm('¿Estás seguro de que deseas cerrar sesión?')) {
                sessionStorage.removeItem('zebra_auth');
                sessionStorage.removeItem('zebra_user');
                sessionStorage.removeItem('zebra_name');
                window.location.href = 'login.html';
            }
        });

        import { createChat } from 'https://cdn.jsdelivr.net/npm/@n8n/chat/dist/chat.bundle.es.js';
        let chatInstance = null;
        window.chatHistory = [];
        
        function obtenerSessionId() {
            const STORAGE_KEY = 'zebra_chat_session_id';
            let sessionId = localStorage.getItem(STORAGE_KEY);
            if (!sessionId) {
                sessionId = `zebra_session_${Date.now()}_${Math.random().toString(36).substring(2, 11)}`;
                localStorage.setItem(STORAGE_KEY, sessionId);
                console.log('✅ Nuevo sessionId creado:', sessionId);
            } else {
                console.log('✅ SessionId recuperado:', sessionId);
            }
            document.getElementById('sessionIdDisplay').textContent = sessionId;
            return sessionId;
        }
        
        function resetearSesion() {
            if (confirm('¿Estás seguro de que quieres iniciar una nueva sesión? Esto borrará toda la memoria de la conversación.')) {
                localStorage.removeItem('zebra_chat_session_id');
                console.log('🔄 Sesión reseteada');
                location.reload();
            }
        }
        
        function capturarMensajesDelChat() {
            setInterval(() => {
                try {
                    const chatContainer = document.querySelector('#n8n-chat');
                    if (!chatContainer) return;
                    const nuevoHistorial = [];
                    const buscadores = ['[data-testid="chat-message"]', '[class*="ChatMessage"]', '[class*="message-"]', 'div[class*="message"][class*="user"], div[class*="message"][class*="bot"]', 'div[class*="message"][class*="assistant"]'];
                    let todosLosMensajes = [];
                    for (const selector of buscadores) {
                        todosLosMensajes = chatContainer.querySelectorAll(selector);
                        if (todosLosMensajes.length > 0) break;
                    }
                    if (todosLosMensajes.length === 0) {
                        const todosDivs = chatContainer.querySelectorAll('div');
                        todosLosMensajes = Array.from(todosDivs).filter(div => {
                            const texto = div.textContent?.trim() || '';
                            const tienehijos = div.children.length;
                            return texto.length > 20 && texto.length < 1000 && tienehijos < 5;
                        });
                    }
                    todosLosMensajes.forEach((msgElement) => {
                        procesarMensaje(msgElement, nuevoHistorial);
                    });
                    if (nuevoHistorial.length > 0 && JSON.stringify(nuevoHistorial) !== JSON.stringify(window.chatHistory)) {
                        window.chatHistory = nuevoHistorial;
                    }
                } catch (error) {
                    console.error('Error capturando mensajes:', error);
                }
            }, 1000);
        }
        
        function procesarMensaje(msgElement, historial) {
            let messageText = msgElement.textContent?.trim() || '';
            messageText = messageText.replace(/\s+/g, ' ').trim();
            if (!messageText || messageText.length < 1 || messageText.length > 800) return;
            const claseCompleta = (msgElement.className || '').toLowerCase();
            const parentClass = (msgElement.parentElement?.className || '').toLowerCase();
            const grandParentClass = (msgElement.parentElement?.parentElement?.className || '').toLowerCase();
            const esUsuario = claseCompleta.includes('user') || parentClass.includes('user') || grandParentClass.includes('user') || msgElement.closest('[class*="user"]') !== null || msgElement.closest('[class*="User"]') !== null;
            const rol = esUsuario ? 'user' : 'IA';
            const yaExiste = historial.some(msg => msg.message === messageText && msg.role === rol);
            if (!yaExiste) {
                historial.push({ role: rol, message: messageText });
            }
        }
        
        function inicializarChat() {
            console.log('Inicializando chat...');
            const chatContainer = document.getElementById('n8n-chat');
            if (!chatContainer) {
                console.error('No se encontró el contenedor #n8n-chat');
                return;
            }
            chatContainer.innerHTML = '';
            window.chatHistory = [];
            const sessionId = obtenerSessionId();
            try {
                chatInstance = createChat({
                    webhookUrl: 'https://n8n-n8n.9qd6cz.easypanel.host/webhook/20a36ed7-8071-4fc5-b11f-be58990e4037/chat',
                    target: '#n8n-chat',
                    mode: 'fullscreen',
                    chatInputKey: 'chatInput',
                    chatSessionKey: 'sessionId',
                    initialMessages: [{id: '1', text: `Sesión iniciada. ID: ${sessionId.substring(0, 20)}...`, sender: 'bot', createdAt: new Date().toISOString()}],
                    metadata: { sessionId: sessionId },
                    showWelcomeScreen: false,
                    defaultLanguage: 'es',
                    i18n: { es: { title: 'Prueba la IA', subtitle: 'Prueba todo lo que se te ocurra', footer: '', getStarted: 'Iniciar conversación', inputPlaceholder: 'Escribe tu mensaje...' } }
                });
                console.log('✅ Chat creado exitosamente con sessionId:', sessionId);
                setTimeout(capturarMensajesDelChat, 2000);
            } catch (error) {
                console.error('❌ Error al crear el chat:', error);
            }
        }
        
        async function verificarStatusConPolling(sessionId, maxIntentos = 60) {
            let intentos = 0;
            const intervalo = 2000;
            return new Promise((resolve, reject) => {
                const polling = setInterval(async () => {
                    intentos++;
                    console.log(`🔍 Verificando status... Intento ${intentos}/${maxIntentos}`);
                    try {
                        const response = await fetch(`https://n8n-n8n.9qd6cz.easypanel.host/webhook/zebra-status-check?sessionId=${sessionId}`, { method: 'GET' });
                        if (!response.ok) {
                            console.warn(`Status check failed: ${response.status}`);
                            if (intentos >= maxIntentos) {
                                clearInterval(polling);
                                reject(new Error('Timeout: El ajuste tardó demasiado'));
                            }
                            return;
                        }
                        const data = await response.json();
                        console.log('📊 Status recibido:', data);
                        if (data.ready === true) {
                            clearInterval(polling);
                            resolve(data);
                            return;
                        }
                        if (intentos >= maxIntentos) {
                            clearInterval(polling);
                            reject(new Error('Timeout: El proceso está tardando más de lo esperado'));
                        }
                    } catch (error) {
                        console.error('Error en polling:', error);
                        if (intentos >= maxIntentos) {
                            clearInterval(polling);
                            reject(error);
                        }
                    }
                }, intervalo);
            });
        }
        
        function mostrarMensaje(texto, tipo, elementId = 'statusMessage') {
            const statusMessage = document.getElementById(elementId);
            statusMessage.textContent = texto;
            statusMessage.className = 'status-message ' + tipo;
            statusMessage.style.display = 'block';
        }
        
        function ocultarMensaje(delay = 5000, elementId = 'statusMessage') {
            setTimeout(() => {
                const statusMessage = document.getElementById(elementId);
                statusMessage.style.display = 'none';
            }, delay);
        }
        
        // 🆕 FUNCIONALIDAD NUEVO PROMPT
        const btnNuevoPrompt = document.getElementById('btnNuevoPrompt');
        const nuevoPromptSection = document.getElementById('nuevoPromptSection');
        const btnCancelarPrompt = document.getElementById('btnCancelarPrompt');
        const btnEnviarPrompt = document.getElementById('btnEnviarPrompt');
        const nuevoPromptInput = document.getElementById('nuevoPromptInput');
        
        btnNuevoPrompt.addEventListener('click', () => {
            nuevoPromptSection.classList.toggle('active');
            if (nuevoPromptSection.classList.contains('active')) {
                btnNuevoPrompt.textContent = '📝 Ocultar Nuevo Prompt';
                nuevoPromptInput.focus();
            } else {
                btnNuevoPrompt.textContent = '📝 Nuevo Prompt';
            }
        });
        
        btnCancelarPrompt.addEventListener('click', () => {
            nuevoPromptSection.classList.remove('active');
            btnNuevoPrompt.textContent = '📝 Nuevo Prompt';
            nuevoPromptInput.value = '';
            document.getElementById('statusMessagePrompt').style.display = 'none';
        });
        
        btnEnviarPrompt.addEventListener('click', async () => {
            const nuevoPrompt = nuevoPromptInput.value.trim();
            
            if (!nuevoPrompt) {
                mostrarMensaje('⚠️ Por favor, escribe el nuevo prompt.', 'error', 'statusMessagePrompt');
                ocultarMensaje(5000, 'statusMessagePrompt');
                return;
            }
            
            if (nuevoPrompt.length < 50) {
                mostrarMensaje('⚠️ El prompt debe tener al menos 50 caracteres.', 'error', 'statusMessagePrompt');
                ocultarMensaje(5000, 'statusMessagePrompt');
                return;
            }
            
            btnEnviarPrompt.disabled = true;
            btnEnviarPrompt.innerHTML = '<div class="spinner"></div> Enviando...';
            mostrarMensaje('📤 Enviando nuevo prompt...', 'processing', 'statusMessagePrompt');
            
            try {
                const payload = {
                    prompt: nuevoPrompt,
                    timestamp: new Date().toISOString()
                };
                
                console.log('📤 Enviando nuevo prompt:', payload);
                
                const response = await fetch('https://n8n-n8n.9qd6cz.easypanel.host/webhook/dc1f2491-0aab-4133-a9af-4925d09acb2c', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: No se pudo enviar el nuevo prompt`);
                }
                
                const result = await response.json();
                console.log('✅ Prompt enviado correctamente:', result);
                
                mostrarMensaje('✅ Nuevo prompt actualizado correctamente', 'success', 'statusMessagePrompt');
                nuevoPromptInput.value = '';
                
                setTimeout(() => {
                    nuevoPromptSection.classList.remove('active');
                    btnNuevoPrompt.textContent = '📝 Nuevo Prompt';
                    mostrarMensaje('💡 El nuevo prompt ha sido aplicado. Puedes probarlo en el chat.', 'success', 'statusMessagePrompt');
                    ocultarMensaje(10000, 'statusMessagePrompt');
                }, 2000);
                
            } catch (error) {
                console.error('❌ Error:', error);
                mostrarMensaje('❌ Error: ' + error.message, 'error', 'statusMessagePrompt');
                ocultarMensaje(5000, 'statusMessagePrompt');
            } finally {
                btnEnviarPrompt.disabled = false;
                btnEnviarPrompt.innerHTML = 'Enviar Prompt';
            }
        });
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', inicializarChat);
        } else {
            inicializarChat();
        }
        
        document.getElementById('btnResetSession').addEventListener('click', resetearSesion);
        
        document.getElementById('btnAjustar').addEventListener('click', async function() {
            const notasInput = document.getElementById('notasInput');
            const btnAjustar = document.getElementById('btnAjustar');
            const correccion = notasInput.value.trim();
            
            if (!correccion) {
                mostrarMensaje('⚠️ Por favor, escribe las correcciones necesarias.', 'error');
                ocultarMensaje();
                return;
            }
            
            if (window.chatHistory.length === 0) {
                mostrarMensaje('⚠️ No hay mensajes en el chat. Envía al menos un mensaje antes de ajustar.', 'error');
                ocultarMensaje();
                return;
            }
            
            btnAjustar.disabled = true;
            btnAjustar.innerHTML = '<div class="spinner"></div> Enviando...';
            mostrarMensaje('📤 Enviando correcciones a n8n...', 'processing');
            
            try {
                let chatTextoPlano = '';
                window.chatHistory.forEach(msg => {
                    chatTextoPlano += `${msg.role}:${msg.message}\n`;
                });
                
                const sessionId = obtenerSessionId();
                const payload = {
                    chat: chatTextoPlano.trim(),
                    correccion: correccion,
                    sessionId: sessionId
                };
                
                console.log('📤 Enviando payload:', payload);
                
                const response = await fetch('https://n8n-n8n.9qd6cz.easypanel.host/webhook/835f0fa0-40b0-4fbb-ad1a-c3d8d30faafb', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: No se pudo enviar la corrección`);
                }
                
                console.log('✅ Corrección enviada correctamente');
                
                btnAjustar.innerHTML = '<div class="spinner"></div> Procesando...';
                mostrarMensaje('⚙️ Procesando ajustes en la IA... Por favor espera', 'processing');
                
                const resultado = await verificarStatusConPolling(sessionId);
                
                console.log('🎉 Proceso completado:', resultado);
                
                mostrarMensaje(resultado.message || '✅ Prompt actualizado correctamente', 'success');
                notasInput.value = '';
                
                setTimeout(() => {
                    mostrarMensaje('💡 Prueba el chat ahora para ver los cambios aplicados', 'success');
                    ocultarMensaje(10000);
                }, 2000);
                
            } catch (error) {
                console.error('❌ Error:', error);
                mostrarMensaje('❌ Error: ' + error.message, 'error');
                ocultarMensaje();
            } finally {
                btnAjustar.disabled = false;
                btnAjustar.innerHTML = 'Ajustar Prompt';
            }
        });
    </script>
</body>
</html>
